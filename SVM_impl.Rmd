---
title: "Support Vector Machine"
author: "Michael In der Au"
date: "6 Juni 2018"
output: pdf_document
---

```{r setup, include=FALSE}
#required packages
library(e1071)
library(mice)
library(caret)
library(ggplot2)
library(dplyr)
library(Hmisc)

# ++++++++++++++++++++++++++++
# flattenCorrMatrix
# ++++++++++++++++++++++++++++
# cormat : matrix of the correlation coefficients
# pmat : matrix of the correlation p-values
flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
  )
}
#read previously inputed data
train <- read.csv("data/train_imputed.csv")
test <- read.csv("data/test_imputed.csv")

#view imputed data
summary(train)
summary(test)

#Preprocessing

#-RevolvingUtilizationOfUnsecuredLines
#-- (total balance) / (total credit limit)

# the closer this value is to 100% the more the consumer is using the credit limit 
summary(train$RevolvingUtilizationOfUnsecuredLines)
mis <-train %>%
  filter(train$RevolvingUtilizationOfUnsecuredLines > 1)
summary(mis)

#percentage of regressor > 1 in train data
nrow(mis)/nrow(train)*100

#apply coded value -1 to outliers
train$RevolvingUtilizationOfUnsecuredLines[train$RevolvingUtilizationOfUnsecuredLines > 1] <- -1

summary(train$RevolvingUtilizationOfUnsecuredLines)

#-age

summary(train$age)
mis <- train %>%
  filter(train$age == 0)
nrow(mis)

#omit line with age = 0
train <- subset(train, age > 0)

#-NumberOfTimeXX_XXDaysPastDueNotWorse

summary(train$NumberOfTime30_59DaysPastDueNotWorse)
summary(train$NumberOfTime60_89DaysPastDueNotWorse)
summary(train$NumberOfTimes90DaysLate)

#it can be assumed that 96 and 98 are coded values of some kind, 
#because both values have their own meaning they cant be ommited
# and have to be encoded in some kind
nrow(subset(train, train$NumberOfTime30_59DaysPastDueNotWorse >=15))
n_96 <- nrow(subset(train, train$NumberOfTime30_59DaysPastDueNotWorse ==96))
n_98 <- nrow(subset(train, train$NumberOfTime30_59DaysPastDueNotWorse ==98))

(n_96+n_98)/nrow(train)*100

train$NumberOfTime30_59DaysPastDueNotWorse[train$NumberOfTime30_59DaysPastDueNotWorse >= 15]<- -1

summary(train$NumberOfTime30_59DaysPastDueNotWorse)

#the same approach applies to NumberOfTime60_89DaysPastDueNotWorse and
#NumberOfTimes90DaysLate
nrow(subset(train, train$NumberOfTime60_89DaysPastDueNotWorse >=15))
n_96 <- nrow(subset(train, train$NumberOfTime60_89DaysPastDueNotWorse ==96))
n_98 <- nrow(subset(train, train$NumberOfTime60_89DaysPastDueNotWorse ==98))

(n_96+n_98)/nrow(train)*100

train$NumberOfTime60_89DaysPastDueNotWorse[train$NumberOfTime60_89DaysPastDueNotWorse >= 15] <- -1

summary(train$NumberOfTime60_89DaysPastDueNotWorse)

summary(train$NumberOfTimes90DaysLate)
nrow(subset(train, train$NumberOfTimes90DaysLate >=19))
n_96 <- nrow(subset(train, train$NumberOfTimes90DaysLate ==96))
n_98 <- nrow(subset(train, train$NumberOfTimes90DaysLate ==98))

(n_96+n_98)/nrow(train)*100

train$NumberOfTimes90DaysLate[train$NumberOfTimes90DaysLate >= 19] <- -1

summary(train$NumberOfTime60_89DaysPastDueNotWorse)

#- DebtRatio
#-- (total debts) / (monthly income)
#-- thus, values > 1 indicate more debts than income

summary(train$DebtRatio)
summary(train$MonthlyIncome)

#monthly income is the denominator of debt ratio thus it cannot be 0
#percentage of regressor > 1 in train data
n_inc0 <- nrow(subset(train, train$MonthlyIncome ==0))
n_inc0/nrow(train)*100

#if the monthly salary is equal to zero it is replaced by -1 

index <- train$MonthlyIncome == 0
train$DebtRatio[index] <- -1
summary(train$MonthlyIncome)

#if the monthly income is missing, it is replaced by 1

train$MonthlyIncome[is.na(train$MonthlyIncome)] <- 1

summary(train$DebtRatio)

#-Monthly income

summary(train$MonthlyIncome)

n_inc50k <- nrow(subset(train, train$MonthlyIncome >50000))
n_inc50k/nrow(train)*100

#omit outliers
train <- subset(train, MonthlyIncome < 50000)

#-NumberOfOpenCreditLinesAndLoans

summary(train$NumberOfOpenCreditLinesAndLoans)

#omit outliers in the 99th percentile

nrow(train[train$NumberOfOpenCreditLinesAndLoans < quantile(train$NumberOfOpenCreditLinesAndLoans, 0.99),])
train <- train[train$NumberOfOpenCreditLinesAndLoans < quantile(train$NumberOfOpenCreditLinesAndLoans, 0.99),]
summary(train$NumberOfOpenCreditLinesAndLoans)

#-NumberOfDependents

summary(train$NumberOfDependents)

#omit outliers in the 99th percentile

nrow(train[train$NumberOfDependents < quantile(train$NumberOfDependents, 0.99),])
train <- train[train$NumberOfDependents < quantile(train$NumberOfDependents, 0.99),]
summary(train$NumberOfDependents)

summary(train)


#remove ids
train <- train[-1]
test <- test[-1]




#Modelling
#seed for reproducibility
set.seed(123)

#svm classifier using e1071
library(e1071)
# classifier <- svm(formula = SeriousDlqin2yrs ~ ., 
#                   data = train, 
#                   type = "C-classification", 
#                   kernel = "linear")

classifier_rbf <- svm(formula = SeriousDlqin2yrs ~ ., 
                  data = train, 
                  type = "C-classification", 
                  kernel = "radial")

# pred_lin <- predict(classifier, newdata = test[-1])
pred_rbf <- predict(classifier_rbf, newdata = train[-1])
```

